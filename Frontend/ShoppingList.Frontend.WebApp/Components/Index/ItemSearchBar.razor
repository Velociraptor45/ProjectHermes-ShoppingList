@using ProjectHermes.ShoppingList.Frontend.WebApp.Pages.Index.Models;
@using ProjectHermes.ShoppingList.Frontend.WebApp.Pages.Index.Services
@using ProjectHermes.ShoppingList.Frontend.Models.ShoppingLists.Services
@using ProjectHermes.ShoppingList.Frontend.Models.ShoppingLists.Models
@using ProjectHermes.ShoppingList.Frontend.Models.Items.Models

@inject ITemporaryItemCreationService temporaryItemCreationService;
@inject IShoppingListApiService apiService;

<div class="mb-2 d-flex">
    <Select OnFocus="OnSearchBarFocusIn"
            Class="@(State.SearchBar.Active ? "ml-1 mr-2 w-100 cursor-text" : "mx-1 w-100 cursor-text")"
            DataSource="State.SearchBar.Options"
            TItem="@SearchItemForShoppingListResult"
            TItemValue="@Guid"
            ValueName="@nameof(SearchItemForShoppingListResult.ItemId)"
            LabelName="@nameof(SearchItemForShoppingListResult.DisplayValue)"
            AutoClearSearchValue="true"
            AllowClear="true"
            OnSearch="s => OnSearchAsync(s)"
            EnableSearch
            OnSelectedItemChanged="item => OnSearchItemSelectedAsync(item)">
    </Select>

    @if (State.SearchBar.Active)
    {
        <TemporaryItemCreator State="@State"></TemporaryItemCreator>
        <Button Class="mr-1" OnClick="@OnSearchBarCancelButtonClicked">Cancel</Button>
    }
</div>

@code {
    [Parameter] public Func<Task> ReloadShoppingListAsync { get; set; }
    [Parameter] public ShoppingListState State { get; set; }
    [Parameter] public ErrorHandler ErrorHandler { get; set; }
    
    private async Task OnSearchAsync(string searchInput)
    {
        if (State.ShoppingList.Store == null)
            return;

        if (string.IsNullOrWhiteSpace(searchInput))
        {
            State.SearchBar.ResetOptions();
            return;
        }

        searchInput = searchInput.Trim();
        State.SearchBar.Input = searchInput;

        await apiService.LoadItemSearchResultAsync(searchInput, State.ShoppingList.Store.Id, ErrorHandler, 
            searchResult =>
            {
                State.SearchBar.Options = searchResult;
                StateHasChanged();
            });
    }

    private async Task OnSearchItemSelectedAsync(SearchItemForShoppingListResult item)
    {
        if (item == null)
            return;

        async Task OnSuccessAction()
        {
            State.SearchBar.ResetInput();
            State.SearchBar.ResetOptions();
            await State.RequestReloadAsync();
        }

        if(item.ItemTypeId == null)
        {
            await apiService.AddItemToShoppingListAsync(
                State.ShoppingList.Id,
                ShoppingListItemId.FromActualId(item.ItemId),
                item.DefaultQuantity,
                item.DefaultSectionId,
                ErrorHandler,
                OnSuccessAction);
        }
        else
        {
            await apiService.AddItemWithTypeToShoppingListAsync(
                State.ShoppingList.Id,
                item.ItemId,
                item.ItemTypeId.Value,
                item.DefaultQuantity,
                item.DefaultSectionId, 
                ErrorHandler,
                OnSuccessAction);
        }
    }

    private void OnSearchBarCancelButtonClicked()
    {
        State.SearchBar.Active = false;
        StateHasChanged();
    }

    private void OnSearchBarFocusIn()
    {
        State.SearchBar.Active = true;
        StateHasChanged();
    }
}