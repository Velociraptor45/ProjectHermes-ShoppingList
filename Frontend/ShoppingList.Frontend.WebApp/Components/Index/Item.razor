@inherits Fluxor.Blazor.Web.Components.FluxorComponent

@using ProjectHermes.ShoppingList.Frontend.WebApp.Pages.Index.Services
@using ProjectHermes.ShoppingList.Frontend.Models
@using System.Text.RegularExpressions
@using Fluxor
@using global::ShoppingList.Frontend.Redux.ShoppingList.Actions
@using global::ShoppingList.Frontend.Redux.ShoppingList.Actions.Items
@using global::ShoppingList.Frontend.Redux.ShoppingList.Actions.PriceUpdater
@using global::ShoppingList.Frontend.Redux.ShoppingList.States
@using ShoppingListState = global::ShoppingList.Frontend.Redux.ShoppingList.States.ShoppingListState

@inject NavigationManager _navigationManager;
@inject IItemPriceCalculationService _itemPriceCalculationService;

@inject IState<ShoppingListState> State
@inject IDispatcher Dispatcher

<li class="item py-2 mb-1 @(Model.IsInBasket ? "green-bg" : "red-bg") white" @onclick="OnItemClicked">
    @if (State.Value.EditModeActive)
    {
        <div class="d-flex flex-column ml-2">
            <div class="d-flex">
                <!-- upper row -->
                <div class="h3 pl-1">@Model.Name</div>
                <Button Danger="true"
                        Icon="close"
                        Class="mr-2 ml-auto d-flex align-items-center justify-content-center"
                        OnClick="@OnRemoveItemButtonClicked"></Button>
            </div>
            <div>
                <!-- lower row -->
                <div class="d-flex">
                    <div class="d-flex">
                        <div class="d-flex mr-3">
                            <AntDesign.InputNumber TValue="float" Value="@Model.Quantity" Min="1f"
                                                   ValueChanged="OnQuantityInputValueChanged">
                            </AntDesign.InputNumber>
                            <span class="align-self-center">@Model.QuantityType.QuantityLabel</span>
                        </div>
                        <div class="d-flex">
                            <Button Class="d-flex align-items-center justify-content-center" Icon="plus"
                                    OnClick="OnIncrementQuantityButtonClicked"></Button>
                            <Button Class="d-flex align-items-center justify-content-center" Icon="minus"
                                    OnClick="OnDecrementQuantityButtonClicked"></Button>
                        </div>
                    </div>
                    @if (Model.IsTemporary)
                    {
                        <div class="px-2 m-0 ml-auto">
                            <Button Icon="download"
                                    OnClick="@OnMakeItemPermanentButtonClicked"
                                    Disabled="@(Model.Id.ActualId == null)">
                            </Button>
                        </div>
                    }
                    else
                    {
                        <div class="px-2 m-0 ml-auto">
                            <Button class="oi-button" OnClick="OnOpenUpdatePriceClicked">
                                <span class="oi oi-dollar"></span>
                            </Button>
                        </div>
                    }
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="d-flex">
            <div class="m-0">
                <span>@Model.Quantity</span><span>@Model.QuantityType.QuantityLabel</span>
            </div>
            <div class="m-0 pl-2">
                @Model.Name
            </div>
            <div class="px-2 m-0 align-self-center ml-auto">
                <span>@($"{CalculatePrice():0.00}")</span>
                <span>€</span>
            </div>
        </div>
    }
</li>

@code{
    [Parameter] public ShoppingListItem Model { get; set; }

    private void OnItemClicked()
    {
        if (State.Value.EditModeActive)
            return;

        if (Model.IsInBasket)
        {
            Dispatcher.Dispatch(new RemoveItemFromBasketAction(Model.Id, Model.TypeId));
        }
        else
        {
            Dispatcher.Dispatch(new PutItemInBasketAction(Model.Id, Model.TypeId));
        }
    }


    private float CalculatePrice()
    {
        return _itemPriceCalculationService.CalculatePrice(Model.QuantityType.Id, Model.PricePerQuantity, Model.Quantity);
    }

    private void OnQuantityInputValueChanged(float quantity)
    {
        Dispatcher.Dispatch(new ChangeItemQuantityAction(Model.Id, Model.TypeId, quantity,
            ChangeItemQuantityAction.ChangeType.Absolute));
    }

    private void OnRemoveItemButtonClicked()
    {
        Dispatcher.Dispatch(new RemoveItemFromShoppingListAction(Model.Id, Model.TypeId));
    }

    private void OnIncrementQuantityButtonClicked()
    {
        Dispatcher.Dispatch(new ChangeItemQuantityAction(Model.Id, Model.TypeId, Model.QuantityType.DefaultQuantity,
            ChangeItemQuantityAction.ChangeType.Diff));
    }

    private void OnDecrementQuantityButtonClicked()
    {
        Dispatcher.Dispatch(new ChangeItemQuantityAction(Model.Id, Model.TypeId, -Model.QuantityType.DefaultQuantity,
            ChangeItemQuantityAction.ChangeType.Diff));
    }

    private void OnMakeItemPermanentButtonClicked()
    {
        Dispatcher.Dispatch(new MakeItemPermanentAction(Model.Id.ActualId!.Value));
    }

    private void OnOpenUpdatePriceClicked()
    {
        Dispatcher.Dispatch(new OpenPriceUpdaterAction(Model));
    }
}