@inject ProjectHermes.ShoppingList.Frontend.WebApp.Pages.Index.Services.IShoppingListApiService apiService;

@using ProjectHermes.ShoppingList.Frontend.Models;
@using ProjectHermes.ShoppingList.Frontend.Models.Index;
@using ProjectHermes.ShoppingList.Frontend.WebApp.Pages.Index.Models;

<Select Class="min-w-100 max-w-200 mr-3"
        DataSource="availableStores.Stores"
        @bind-Value="availableStores.SelectedStoreId"
        ValueName="@nameof(Store.Id)"
        LabelName="@nameof(Store.Name)"
        OnSelectedItemChanged="OnSelectionChanged">
</Select>

@code {
    [Parameter] public ShoppingListState Page { get; set; }
    [Parameter] public ErrorHandler ErrorHandler { get; set; }

    private AvailableStores availableStores = new(Enumerable.Empty<Store>(), Guid.Empty);

    protected override async Task OnInitializedAsync()
    {
        await LoadAvailableStoresAsync();

        await base.OnInitializedAsync();
    }

    private async Task LoadAvailableStoresAsync()
    {
        var stores = await apiService.LoadAllActiveStoresAsync(ErrorHandler);
        if (stores == null)
            return;

        var storesList = stores.ToList();


        availableStores = new AvailableStores(storesList, storesList.FirstOrDefault()?.Id ?? Guid.Empty);
        Page.RegisterAvailableStores(availableStores);
        await Page.ReloadRequestedAsync?.Invoke(availableStores.SelectedStoreId);
    }

    private async void OnSelectionChanged(Store store)
    {
        if (store == null)
            return;

        await Page.ChangeStoreAsync(store.Id);
    }
}