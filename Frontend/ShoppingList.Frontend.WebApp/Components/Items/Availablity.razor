@using ProjectHermes.ShoppingList.Frontend.Models.Items;
@using ProjectHermes.ShoppingList.Frontend.Models;
@using OneOf;

<div class="d-flex flex-row align-items-center">
    <div class="max-w-60">
        <Input @bind-Value="@Availability.PricePerQuantity" />
    </div>
    <div class="mr-4">@PriceLabel</div>
    @*<Select Placeholder="Stores" DefaultValue="@Availability.Store.Id.ToString()" OnChange="@OnStoreChanged">
            @foreach (var store in Stores)
            {
                <SelectOption Value=@store.Id.ToString() Class="min-w-100"
                              Disabled="@DisabledStoreIds.Contains(store.Id)">@store.Name</SelectOption>
                        }
        </Select>*@
    <Select DataSource="Stores"
            @bind-Value="@selected"
            ValueName="@nameof(Store.Id)"
            LabelName="@nameof(Store.Name)">
    </Select>
    <SingleSelect DefaultValue="@Availability.DefaultSection.Id.ToString()"
                  CanAddItem="false"
                  AllowClear="false"
                  IdToNameMaps="@Availability.Store.Sections.Select(s => new Tuple<int, string>(s.Id, s.Name)).ToList()"
                  OnChangeCallback="@OnDefaultSectionChanged"></SingleSelect>
    <div class="ml-2">
        <Button Class="d-flex align-items-center"
                OnClick="@OnRemoveStoreButtonClickedAsync"
                Danger="true">
            <Icon Type="minus"></Icon>
        </Button>
    </div>
</div>

@code {
    [Parameter] public int ComponentIndex { get; set; }
    [Parameter] public StoreItemAvailability Availability { get; set; }
    [Parameter] public string PriceLabel { get; set; }
    [Parameter] public List<Store> Stores { get; set; }
    [Parameter] public IEnumerable<int> DisabledStoreIds { get; set; }

    [Parameter] public EventCallback<int> OnRemoveAvailabilityCallback { get; set; }

    private Store selected;

    //private void OnStoreChanged(
    //    OneOf<string, IEnumerable<string>, LabeledValue, IEnumerable<LabeledValue>> value,
    //    OneOf<SelectOption, IEnumerable<SelectOption>> option)
    //{
    //    var storeId = int.Parse(value.AsT0);
    //    var store = Stores.Single(s => s.Id == storeId);
    //    Availability.Store = store.AsStoreItemStore();

    //    var defaultSection = store.Sections.Single(s => s.IsDefaultSection);
    //    Availability.ChangeDefaultSection(defaultSection.AsStoreItemSection());
    //    StateHasChanged();
    //}

    private async Task OnRemoveStoreButtonClickedAsync()
    {
        await OnRemoveAvailabilityCallback.InvokeAsync(ComponentIndex);
    }

    private void OnDefaultSectionChanged(int sectionId)
    {
        var section = Availability.Store.Sections.Single(s => s.Id == sectionId);
        Availability.ChangeDefaultSection(section);
    }
}